SELECT
      pcn.CD_MATRICULA AS ID,
      pcn.NM_COLABORADOR AS NOME_COLABORADOR,
      pcn.ENC_VL_SALARIO_BASE AS SALARIO_DEZ_2023,
      pcn.ENC_VL_MEDIA_COMISSAO AS MEDIA_COMISSAO,
      pcn.DT_ADMISSAO AS DATA_ADMISSAO,
      pcn.CD_FUNCAO AS COD_FUNCAO_DEZ_2023,
      pcn.DS_FUNCAO AS FUNCAO_DEZ_2023,
      pcn.NO_AVOS_GERAL AS AVOS_A_DESCONSIDERAR,
      pcn.ENC_NO_TARGET_GERAL AS TARGET,
      pcn.NO_AVOS_GERAL AS AVOS_ADMISSAO,
      pcn.DS_NIVEL1 AS DESC_ESTRUT_1_CC,
      pcn.DS_NIVEL2 AS DESC_ESTRUT_2_CC,
      pcn.DS_NIVEL3 AS DESC_ESTRUT_3_CC,
      pcn.DS_NIVEL4 AS DESC_ESTRUT_4_CC,
      pcn.CD_CENTRO_RESULTADO AS COD_CENTRO_RESULTADO,
      pcn.DS_CENTRO_RESULTADO AS DES_CENTRO_RESULTADO,
      pcn.NM_OWNER_PAINEL AS PAINEL,
      pcn.ENC_NO_NOTA_PAINEL AS NOTA_PAINEL,
      pcn.ENC_NO_NOTA_DISCRICIONARIO AS DISCRICIONARIO,
      pcn.ENC_VL_CALC_SEM_P_RATA AS CALCULO_S_PRO_RATA,
      pcn.ENC_VL_TOTAL_PRO_RATA AS CALCULO_S_PRO_RATA_C_PERFORMANCE,
      pcn.ENC_VL_TOTAL_PRO_RATA AS TOTAL_PRO_RATA,
      pcn.ENC_VL_TOTAL_C_PERF_SCORE AS TOTAL_CPS,
      pcn.NO_AVOS_ADM_DESC_AFAST_GERAL AS AVOS_ADMISSAO_C_DESCONTO_AFASTAMENTO,
      pcn.PC_OBJETIVO_GRUPO AS OBJETIVOS_GRUPO,
      pcn.PC_OBJETIVO AS OBJETIVOS,
      pcn.ENC_NO_NOTA_PAINEL_FINAL AS PAINEL_FINAL,
      pcn.NO_AVOS_GERAL AS AVOS,
      pcn.NO_MOV_CICLO AS NUM_MOVIMENTOS_2023,
      pcn.PC_PERF_SCORE AS PERFORMANCE_SCORE,
      pha.DT_INI_AFASTAMENTO AS DATA_AFASTAMENTO,
      pha.CD_MOTIVO_INTERNO_AFASTAMENTO AS MOTIVO, 
      pcn.DS_NIVEL3 AS DESC_NEGOCIO,
      pfe.DS_GP_META AS PPR_DEZ_2023,
      pcn.ST_COLABORADOR AS STATUS,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.DT_INICIO END) AS DATA_PRE_MOVIMENTOS,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.DS_FUNCAO END) AS DESC_PRE_MOVIMENTOS,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.DT_INICIO END) AS MOV1_DATE,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.ENC_NO_TARGET END) AS MOV1_TARGET,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.DS_FUNCAO END) AS MOV1_DS_FUNC,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.NO_AVOS END) AS MOV1_NO_AVOS,
      MAX(CASE WHEN pcp.RN = 1 THEN (SELECT pfe2.DS_GP_META FROM PPR_FUNCAO_ELEGIVEL pfe2 WHERE pfe2.CD_FUNCAO = pcp.CD_FUNCAO AND pfe2.NO_ANO_CICLO = pcp.NO_ANO_CICLO) END) AS MOV1_PPR,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.DT_INICIO END) AS MOV2_DATE,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.ENC_NO_TARGET END) AS MOV2_TARGET,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.DS_FUNCAO END) AS MOV2_DS_FUNC,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.NO_AVOS END) AS MOV2_NO_AVOS,
      MAX(CASE WHEN pcp.RN = 2 THEN (SELECT pfe2.DS_GP_META FROM PPR_FUNCAO_ELEGIVEL pfe2 WHERE pfe2.CD_FUNCAO = pcp.CD_FUNCAO AND pfe2.NO_ANO_CICLO = pcp.NO_ANO_CICLO) END) AS MOV2_PPR,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.DT_INICIO END) AS MOV3_DATE,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.ENC_NO_TARGET END) AS MOV3_TARGET,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.DS_FUNCAO END) AS MOV3_DS_FUNC,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.NO_AVOS END) AS MOV3_NO_AVOS,
      MAX(CASE WHEN pcp.RN = 3 THEN (SELECT pfe2.DS_GP_META FROM PPR_FUNCAO_ELEGIVEL pfe2 WHERE pfe2.CD_FUNCAO = pcp.CD_FUNCAO AND pfe2.NO_ANO_CICLO = pcp.NO_ANO_CICLO) END) AS MOV3_PPR,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.ENC_VL_MEDIA_COMISSAO END) AS MOV1_MEDIA_COMISSAO,
      MAX(CASE WHEN pcp.RN = 1 THEN pcp.ENC_VL_MEDIA_COMISSAO_DSR END) AS MOV1_MEDIA_COMISSAO_DSR,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.ENC_VL_MEDIA_COMISSAO END) AS MOV2_MEDIA_COMISSAO,
      MAX(CASE WHEN pcp.RN = 2 THEN pcp.ENC_VL_MEDIA_COMISSAO_DSR END) AS MOV2_MEDIA_COMISSAO_DSR,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.ENC_VL_MEDIA_COMISSAO END) AS MOV3_MEDIA_COMISSAO,
      MAX(CASE WHEN pcp.RN = 3 THEN pcp.ENC_VL_MEDIA_COMISSAO_DSR END) AS MOV3_MEDIA_COMISSAO_DSR
    FROM
        ppr_calculo_normal pcn
    LEFT JOIN (
        SELECT
            CD_MATRICULA,
            NO_ANO_CICLO,
            DT_INICIO,
            DS_FUNCAO,
            NO_AVOS,
            ENC_VL_PPR_COM_SCORE,
            ENC_NO_TARGET,
            CD_FUNCAO,
            ENC_VL_MEDIA_COMISSAO_DSR,
            ENC_VL_MEDIA_COMISSAO,
            ENC_VL_SALARIO_BASE,
            ROW_NUMBER() OVER (PARTITION BY CD_MATRICULA, NO_ANO_CICLO ORDER BY DT_INICIO) AS RN
        FROM
            PPR_CALCULO_PRORATA
    ) pcp ON pcn.CD_MATRICULA = pcp.CD_MATRICULA AND pcn.NO_ANO_CICLO = pcp.NO_ANO_CICLO
    LEFT JOIN PPR_HISTORICO_AFASTAMENTO pha ON pha.CD_MATRICULA = pcn.CD_MATRICULA 
    LEFT JOIN PPR_FUNCAO_ELEGIVEL pfe ON pfe.CD_FUNCAO = pcn.CD_FUNCAO AND pfe.NO_ANO_CICLO = pcn.NO_ANO_CICLO 
    WHERE pcn.NO_ANO_CICLO = 2023
    GROUP BY
      pcn.CD_MATRICULA,
      pcn.NM_COLABORADOR,
      pcn.ENC_VL_SALARIO_BASE,
      pcn.ENC_VL_MEDIA_COMISSAO,
      pcn.DT_ADMISSAO,
      pcn.CD_FUNCAO,
      pcn.DS_FUNCAO,
      pcn.NO_AVOS_GERAL,
      pcn.ENC_NO_TARGET_GERAL,
      pcn.NO_AVOS_GERAL,
      pcn.DS_NIVEL1,
      pcn.DS_NIVEL2,
      pcn.DS_NIVEL3,
      pcn.DS_NIVEL4,
      pcn.CD_CENTRO_RESULTADO,
      pcn.DS_CENTRO_RESULTADO,
      pcn.NM_OWNER_PAINEL,
      pcn.ENC_NO_NOTA_PAINEL,
      pcn.ENC_NO_NOTA_DISCRICIONARIO,
      pcn.ENC_VL_CALC_SEM_P_RATA,
      pcn.ENC_VL_TOTAL_PRO_RATA,
      pcn.ENC_VL_TOTAL_PRO_RATA,
      pcn.ENC_VL_TOTAL_C_PERF_SCORE,
      pcn.NO_AVOS_ADM_DESC_AFAST_GERAL,
      pcn.PC_OBJETIVO_GRUPO,
      pcn.PC_OBJETIVO,
      pcn.ENC_NO_NOTA_PAINEL_FINAL,
      pcn.NO_AVOS_GERAL,
      pcn.NO_MOV_CICLO,
      pcn.PC_PERF_SCORE,
      pha.DT_INI_AFASTAMENTO,
      pha.CD_MOTIVO_INTERNO_AFASTAMENTO ,
      pcn.DS_NIVEL3,
      pfe.DS_GP_META,
      pcn.ST_COLABORADOR
    OFFSET 0 ROWS FETCH NEXT 1000 ROWS ONLY